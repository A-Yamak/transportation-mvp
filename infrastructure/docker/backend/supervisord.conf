# ==============================================================================
# Al-Sabiqoon - Supervisor Configuration
# ==============================================================================
# Manages Laravel Horizon queue workers and scheduler
# Used in Kubernetes worker pods for background job processing
#
# Programs:
#   - horizon: Laravel Horizon for queue management
#   - scheduler: Laravel scheduler (replaces cron)
# ==============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/var/run/supervisord.pid
loglevel=info

# ------------------------------------------------------------------------------
# Laravel Horizon - Queue Worker Management
# ------------------------------------------------------------------------------
# Horizon manages queue workers with auto-balancing and monitoring.
# It requires Redis as the queue driver.
#
# Graceful shutdown: Horizon waits for current jobs to complete before stopping.
# The stopwaitsecs should be higher than the longest expected job duration.

[program:horizon]
process_name=%(program_name)s
command=php /app/artisan horizon
autostart=true
autorestart=true
user=alsabiqoon
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stopwaitsecs=3600
stopsignal=SIGTERM

# ------------------------------------------------------------------------------
# Laravel Scheduler - Cron Replacement
# ------------------------------------------------------------------------------
# Runs the Laravel scheduler every minute.
# This replaces the need for system cron inside the container.
#
# The scheduler checks app/Console/Kernel.php for scheduled tasks.

[program:scheduler]
process_name=%(program_name)s
command=/bin/sh -c "while [ true ]; do php /app/artisan schedule:run --verbose --no-interaction; sleep 60; done"
autostart=true
autorestart=true
user=alsabiqoon
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stopwaitsecs=60
