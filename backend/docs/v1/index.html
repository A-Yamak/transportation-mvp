<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Sabiqoon Backend Documentation v1</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --code-bg: #1e293b;
            --code-text: #e2e8f0;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 3rem 2rem;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 0.5rem;
            margin-top: 1rem;
        }

        .badge-php { background: #777bb4; color: white; }
        .badge-laravel { background: #ff2d20; color: white; }
        .badge-octane { background: #f97316; color: white; }

        nav {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: sticky;
            top: 1rem;
        }

        nav h3 {
            margin-bottom: 1rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        nav a {
            color: var(--primary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            background: var(--bg);
            font-size: 0.875rem;
            transition: background 0.2s;
        }

        nav a:hover {
            background: var(--primary);
            color: white;
        }

        section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        h2 {
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        h3 {
            margin: 1.5rem 0 1rem;
            color: var(--text);
        }

        h4 {
            margin: 1rem 0 0.5rem;
            color: var(--text-muted);
        }

        p {
            margin-bottom: 1rem;
        }

        pre {
            background: var(--code-bg);
            color: var(--code-text);
            padding: 1.5rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        code {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
        }

        :not(pre) > code {
            background: var(--bg);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            color: var(--primary-dark);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg);
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        tr:hover {
            background: var(--bg);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .card {
            background: var(--bg);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .card h4 {
            margin-top: 0;
            color: var(--primary-dark);
        }

        .status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-success { background: var(--success); }
        .status-warning { background: var(--warning); }
        .status-error { background: var(--error); }

        .file-tree {
            font-family: monospace;
            font-size: 0.875rem;
            background: var(--bg);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .file-tree ul {
            list-style: none;
            padding-left: 1.5rem;
        }

        .file-tree > ul {
            padding-left: 0;
        }

        .file-tree li {
            padding: 0.25rem 0;
        }

        .file-tree .folder { color: var(--primary); }
        .file-tree .file { color: var(--text-muted); }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            header {
                padding: 2rem 1rem;
            }

            header h1 {
                font-size: 1.75rem;
            }

            nav {
                position: static;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Al-Sabiqoon Backend</h1>
            <p>Laravel 12 API with FrankenPHP, Octane, Horizon, and Passport</p>
            <div>
                <span class="badge badge-php">PHP 8.4</span>
                <span class="badge badge-laravel">Laravel 12</span>
                <span class="badge badge-octane">Octane</span>
            </div>
        </div>
    </header>

    <div class="container">
        <nav>
            <h3>Quick Navigation</h3>
            <ul>
                <li><a href="#overview">Overview</a></li>
                <li><a href="#stack">Tech Stack</a></li>
                <li><a href="#structure">Structure</a></li>
                <li><a href="#configuration">Configuration</a></li>
                <li><a href="#docker">Docker</a></li>
                <li><a href="#kubernetes">Kubernetes</a></li>
                <li><a href="#testing">Testing</a></li>
                <li><a href="#commands">Commands</a></li>
            </ul>
        </nav>

        <section id="overview">
            <h2>Overview</h2>
            <p>The Al-Sabiqoon backend is a high-performance Laravel 12 API designed for the global full-service accelerator platform. It uses FrankenPHP with Octane for blazing-fast request handling, Horizon for queue management, and Passport for OAuth2 authentication.</p>

            <div class="grid">
                <div class="card">
                    <h4><span class="status status-success"></span>Production Ready</h4>
                    <p>Multi-stage Docker builds optimized for Kubernetes deployment with health checks, graceful shutdown, and auto-scaling.</p>
                </div>
                <div class="card">
                    <h4><span class="status status-success"></span>TDD Enabled</h4>
                    <p>PHPUnit configured with coverage reports, multiple test suites (Unit, Feature, Integration), and helper assertions.</p>
                </div>
                <div class="card">
                    <h4><span class="status status-success"></span>Cloud Storage</h4>
                    <p>Cloudflare R2 integration for scalable, cost-effective file storage with global CDN distribution.</p>
                </div>
            </div>
        </section>

        <!-- NEW: Key Concepts for Beginners -->
        <section id="concepts">
            <h2>Key Concepts for Beginners</h2>
            <p>If you're new to Laravel or these technologies, this section explains what each tool does in simple terms.</p>

            <div class="card" style="margin-bottom: 1.5rem; background: #eff6ff; border-left: 4px solid var(--primary);">
                <h4 style="margin-top: 0;">Laravel Octane</h4>
                <p><strong>What problem does it solve?</strong></p>
                <p>Traditional PHP works like this: every time someone visits your website, PHP loads your entire application from scratch, handles the request, and then throws everything away. This "boot, process, forget" cycle happens thousands of times per second.</p>
                <p><strong>How Octane helps:</strong></p>
                <p>Octane keeps your application running in memory. Instead of starting fresh for each request, it boots once and handles all requests from that warm state. Think of it like keeping your car engine running all day vs. starting it for every trip to the mailbox.</p>
                <p><strong>Real-world impact:</strong> Your API can be 2-10x faster, handling many more requests with fewer server resources.</p>
                <pre><code># Start your app with Octane (production)
php artisan octane:start --server=frankenphp --host=0.0.0.0 --port=8000

# In development, we use regular artisan serve for simplicity
php artisan serve</code></pre>
            </div>

            <div class="card" style="margin-bottom: 1.5rem; background: #f0fdf4; border-left: 4px solid var(--success);">
                <h4 style="margin-top: 0;">FrankenPHP</h4>
                <p><strong>What is it?</strong></p>
                <p>FrankenPHP is one of several "engines" that can power Octane. Others include Swoole and RoadRunner. Think of Octane as the interface and FrankenPHP as the implementation.</p>
                <p><strong>Why FrankenPHP?</strong></p>
                <ul>
                    <li>Written in Go (fast and memory-efficient)</li>
                    <li>Supports HTTP/2 and HTTP/3 (modern web protocols)</li>
                    <li>Automatic HTTPS with Let's Encrypt</li>
                    <li>Created by the Symfony team (well-maintained)</li>
                    <li>Works great with Docker</li>
                </ul>
            </div>

            <div class="card" style="margin-bottom: 1.5rem; background: #fef3c7; border-left: 4px solid var(--warning);">
                <h4 style="margin-top: 0;">Laravel Horizon</h4>
                <p><strong>What problem does it solve?</strong></p>
                <p>Some tasks are too slow to do while the user waits: sending emails, generating PDFs, processing images, syncing data with external APIs. If you did these during a web request, users would wait forever.</p>
                <p><strong>How queues work:</strong></p>
                <ol>
                    <li>User requests something that requires slow processing</li>
                    <li>You "queue" the job - save it to Redis for later</li>
                    <li>Respond to user immediately: "Your request is being processed!"</li>
                    <li>A background worker picks up the job and processes it</li>
                    <li>Optionally notify the user when done</li>
                </ol>
                <p><strong>What Horizon does:</strong></p>
                <p>Horizon is a beautiful dashboard that shows you all your queued jobs: what's running, what's waiting, what failed, and how long things take. It also manages the worker processes automatically.</p>
                <pre><code># Create a job class
php artisan make:job ProcessUserUpload

# In your controller, queue the job instead of running it
ProcessUserUpload::dispatch($user, $file);
// User gets response immediately!

# Start Horizon to process queued jobs
php artisan horizon
# Or in Docker: make logs-horizon</code></pre>
            </div>

            <div class="card" style="margin-bottom: 1.5rem; background: #fce7f3; border-left: 4px solid #ec4899;">
                <h4 style="margin-top: 0;">Laravel Tinker</h4>
                <p><strong>What is it?</strong></p>
                <p>Tinker is an interactive command-line shell (called a REPL - Read Eval Print Loop) where you can type PHP code and see results immediately. It's like a playground for testing code.</p>
                <p><strong>When to use it:</strong></p>
                <ul>
                    <li>Testing Eloquent queries before writing them in code</li>
                    <li>Debugging issues by inspecting data</li>
                    <li>Quick data fixes (update a user's email, etc.)</li>
                    <li>Learning how Laravel works</li>
                </ul>
                <pre><code># Start Tinker
make tinker

# Inside Tinker, try these:
>>> User::count()
=> 42

>>> User::where('email', 'like', '%@gmail.com')->count()
=> 28

>>> $user = User::find(1)
>>> $user->name
=> "John Doe"

>>> $user->update(['name' => 'Jane Doe'])
=> true

>>> User::factory()->create(['name' => 'Test User'])
=> App\Models\User {id: 43, name: "Test User", ...}

>>> exit  // To exit Tinker</code></pre>
            </div>

            <div class="card" style="margin-bottom: 1.5rem; background: #fef2f2; border-left: 4px solid var(--error);">
                <h4 style="margin-top: 0;">PHPUnit Testing</h4>
                <p><strong>Why write tests?</strong></p>
                <p>Tests are automated checks that verify your code works correctly. Instead of manually clicking through your app after every change, you run tests that do it for you in seconds.</p>
                <p><strong>Types of tests:</strong></p>
                <ul>
                    <li><strong>Unit tests:</strong> Test a single function/method in isolation</li>
                    <li><strong>Feature tests:</strong> Test HTTP endpoints (API requests and responses)</li>
                    <li><strong>Integration tests:</strong> Test multiple components working together</li>
                </ul>
                <p><strong>TDD (Test-Driven Development):</strong></p>
                <ol>
                    <li>Write a test for the feature you want</li>
                    <li>Run the test - it should fail (feature doesn't exist yet)</li>
                    <li>Write the minimum code to make the test pass</li>
                    <li>Refactor while keeping tests green</li>
                </ol>
                <pre><code># Create a test
php artisan make:test UserRegistrationTest

# Example test (tests/Feature/UserRegistrationTest.php)
public function test_user_can_register(): void
{
    $response = $this->postJson('/api/register', [
        'name' => 'John Doe',
        'email' => 'john@example.com',
        'password' => 'password123',
    ]);

    $response->assertStatus(201);
    $this->assertDatabaseHas('users', [
        'email' => 'john@example.com'
    ]);
}

# Run tests
make test              # All tests
make test-unit         # Only unit tests
make test-feature      # Only feature tests
make test-filter name="UserRegistrationTest"  # Specific test</code></pre>
            </div>

            <div class="card" style="margin-bottom: 1.5rem; background: #f5f3ff; border-left: 4px solid #8b5cf6;">
                <h4 style="margin-top: 0;">Laravel Passport (OAuth2)</h4>
                <p><strong>What problem does it solve?</strong></p>
                <p>When your frontend (Vue app) calls your backend API, how does the API know who the user is? You can't just send username/password with every request - that's insecure.</p>
                <p><strong>How Passport works:</strong></p>
                <ol>
                    <li>User logs in with email/password</li>
                    <li>If valid, server creates an "access token" (a long random string)</li>
                    <li>Frontend stores this token (usually in localStorage or cookie)</li>
                    <li>Every API request includes this token in headers</li>
                    <li>Server validates the token and knows who the user is</li>
                </ol>
                <pre><code>// Login endpoint returns a token
{
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "token_type": "Bearer",
    "expires_in": 31536000
}

// Frontend sends token with every request
fetch('/api/user', {
    headers: {
        'Authorization': 'Bearer eyJ0eXAiOiJKV1QiLCJhbGc...'
    }
})</code></pre>
            </div>

            <div class="card" style="margin-bottom: 1.5rem; background: #ecfdf5; border-left: 4px solid #10b981;">
                <h4 style="margin-top: 0;">Redis</h4>
                <p><strong>What is it?</strong></p>
                <p>Redis is an "in-memory data store" - it stores data in RAM instead of on disk. This makes it incredibly fast (microseconds vs milliseconds).</p>
                <p><strong>What we use Redis for:</strong></p>
                <ul>
                    <li><strong>Cache:</strong> Store frequently-accessed data (e.g., user profiles, API responses) to avoid hitting the database repeatedly</li>
                    <li><strong>Sessions:</strong> Store user login sessions so they persist across requests</li>
                    <li><strong>Queues:</strong> Store background jobs waiting to be processed (used by Horizon)</li>
                </ul>
                <pre><code># Access Redis CLI to see what's stored
make shell-redis

# Inside Redis CLI:
127.0.0.1:6379> KEYS *
1) "laravel_cache:user:1"
2) "laravel_session:abc123"
3) "horizon:queue:default"

127.0.0.1:6379> GET laravel_cache:user:1
"{\"id\":1,\"name\":\"John Doe\"}"</code></pre>
                <p style="margin-top: 1rem;"><strong>Redis Isolation (k3s):</strong> When sharing Redis across environments:</p>
                <table style="font-size: 0.85rem; margin: 1rem 0;">
                    <thead>
                        <tr><th>Environment</th><th>DB Numbers</th><th>Prefix</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Local</td><td>0, 1, 2</td><td><code>alsabiqoon_local_</code></td></tr>
                        <tr><td>Staging</td><td>3, 4, 5</td><td><code>alsabiqoon_staging_</code></td></tr>
                        <tr><td>Production</td><td>6, 7, 8</td><td><code>alsabiqoon_prod_</code></td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card" style="margin-bottom: 1.5rem; background: #f0f4ff; border-left: 4px solid #6366f1;">
                <h4 style="margin-top: 0;">Laravel Telescope & Authorization</h4>
                <p><strong>What is it?</strong></p>
                <p>Telescope is a debug dashboard showing requests, queries, logs, exceptions, mail, and more. It's enabled in all environments with different recording modes.</p>
                <p><strong>Authorization:</strong></p>
                <p>In non-local environments, access requires authentication via email whitelist:</p>
                <pre><code># Set in .env or K8s ConfigMap
DASHBOARD_AUTHORIZED_EMAILS=admin@alsabiqoon.com,dev@alsabiqoon.com</code></pre>
                <p style="margin-top: 1rem;"><strong>Recording Modes:</strong></p>
                <table style="font-size: 0.85rem; margin: 0.5rem 0;">
                    <thead>
                        <tr><th>Mode</th><th>Records</th><th>Use Case</th></tr>
                    </thead>
                    <tbody>
                        <tr><td><code>all</code></td><td>Everything</td><td>Local, Staging</td></tr>
                        <tr><td><code>errors_only</code></td><td>Exceptions, failed requests/jobs, logs, mail</td><td>Production</td></tr>
                        <tr><td><code>important_only</code></td><td>Critical errors only</td><td>High-traffic prod</td></tr>
                    </tbody>
                </table>
                <pre style="margin-top: 1rem;"><code># Environment variables
TELESCOPE_ENABLED=true
TELESCOPE_RECORDING_MODE=errors_only  # For production
TELESCOPE_PRUNE_HOURS=48              # Auto-delete after 48h</code></pre>
            </div>

            <div class="card" style="margin-bottom: 1.5rem; background: #f8fafc; border-left: 4px solid #64748b;">
                <h4 style="margin-top: 0;">Laravel Artisan</h4>
                <p><strong>What is it?</strong></p>
                <p>Artisan is Laravel's command-line interface. It provides dozens of helpful commands for common tasks like creating files, running migrations, clearing caches, and more.</p>
                <p><strong>Common commands you'll use:</strong></p>
                <pre><code># Create things
php artisan make:model Post -m     # Model + Migration
php artisan make:controller PostController
php artisan make:migration create_posts_table
php artisan make:test PostTest
php artisan make:job ProcessPost

# Database
php artisan migrate                # Run pending migrations
php artisan migrate:fresh --seed   # Reset DB and seed data
php artisan db:seed                # Run seeders

# Cache
php artisan cache:clear            # Clear cache
php artisan config:clear           # Clear config cache
php artisan route:clear            # Clear route cache

# Info
php artisan route:list             # Show all routes
php artisan about                  # Show app info

# Via Docker (in our setup):
make artisan cmd="make:model Post -m"</code></pre>
            </div>
        </section>

        <section id="stack">
            <h2>Technology Stack</h2>

            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Technology</th>
                        <th>Version</th>
                        <th>Purpose</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Language</td>
                        <td>PHP</td>
                        <td>^8.4</td>
                        <td>Core programming language</td>
                    </tr>
                    <tr>
                        <td>Framework</td>
                        <td>Laravel</td>
                        <td>^12.0</td>
                        <td>Web application framework</td>
                    </tr>
                    <tr>
                        <td>Server</td>
                        <td>FrankenPHP</td>
                        <td>Latest</td>
                        <td>High-performance PHP server</td>
                    </tr>
                    <tr>
                        <td>Performance</td>
                        <td>Laravel Octane</td>
                        <td>^2.13</td>
                        <td>Application server with worker mode</td>
                    </tr>
                    <tr>
                        <td>Queue</td>
                        <td>Laravel Horizon</td>
                        <td>^5.41</td>
                        <td>Redis queue management dashboard</td>
                    </tr>
                    <tr>
                        <td>Authentication</td>
                        <td>Laravel Passport</td>
                        <td>^13.4</td>
                        <td>OAuth2 server for API auth</td>
                    </tr>
                    <tr>
                        <td>Admin Panel</td>
                        <td>Filament</td>
                        <td>^4.0</td>
                        <td>Admin interface builder</td>
                    </tr>
                    <tr>
                        <td>Debugging</td>
                        <td>Laravel Telescope</td>
                        <td>^5.16</td>
                        <td>Debug assistant and profiler</td>
                    </tr>
                    <tr>
                        <td>Database</td>
                        <td>MySQL</td>
                        <td>8.0</td>
                        <td>Primary data storage</td>
                    </tr>
                    <tr>
                        <td>Cache/Queue</td>
                        <td>Redis</td>
                        <td>7.x</td>
                        <td>Caching, sessions, and queues</td>
                    </tr>
                    <tr>
                        <td>Storage</td>
                        <td>Cloudflare R2</td>
                        <td>-</td>
                        <td>S3-compatible object storage</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="structure">
            <h2>Project Structure</h2>

            <div class="file-tree">
                <ul>
                    <li><span class="folder">app/</span>
                        <ul>
                            <li><span class="folder">Http/Controllers/</span> - API Controllers</li>
                            <li><span class="folder">Models/</span> - Eloquent Models</li>
                            <li><span class="folder">Providers/</span> - Service Providers
                                <ul>
                                    <li><span class="file">AppServiceProvider.php</span></li>
                                    <li><span class="folder">Filament/</span> - Admin Panel Provider</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li><span class="folder">config/</span>
                        <ul>
                            <li><span class="file">octane.php</span> - FrankenPHP configuration</li>
                            <li><span class="file">horizon.php</span> - Queue worker configuration</li>
                            <li><span class="file">filesystems.php</span> - Storage (local, R2)</li>
                            <li><span class="file">database.php</span> - MySQL + Redis config</li>
                        </ul>
                    </li>
                    <li><span class="folder">database/</span>
                        <ul>
                            <li><span class="folder">migrations/</span> - Database schema</li>
                            <li><span class="folder">factories/</span> - Model factories for testing</li>
                            <li><span class="folder">seeders/</span> - Database seeders</li>
                        </ul>
                    </li>
                    <li><span class="folder">routes/</span>
                        <ul>
                            <li><span class="file">web.php</span> - Web routes</li>
                            <li><span class="file">api.php</span> - API routes (create this)</li>
                            <li><span class="file">console.php</span> - Artisan commands</li>
                        </ul>
                    </li>
                    <li><span class="folder">tests/</span>
                        <ul>
                            <li><span class="folder">Unit/</span> - Unit tests</li>
                            <li><span class="folder">Feature/</span> - Feature tests</li>
                            <li><span class="folder">Integration/</span> - Integration tests</li>
                            <li><span class="file">TestCase.php</span> - Base test class</li>
                        </ul>
                    </li>
                    <li><span class="folder">docs/</span>
                        <ul>
                            <li><span class="folder">v1/</span> - This documentation</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </section>

        <section id="configuration">
            <h2>Configuration</h2>

            <h3>Environment Files</h3>
            <table>
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Purpose</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>.env.example</code></td>
                        <td>Template for local Docker development</td>
                    </tr>
                    <tr>
                        <td><code>.env.staging.example</code></td>
                        <td>Template for staging deployment</td>
                    </tr>
                    <tr>
                        <td><code>.env.production.example</code></td>
                        <td>Template for production deployment</td>
                    </tr>
                </tbody>
            </table>

            <h3>Octane Configuration</h3>
            <p>Located at <code>config/octane.php</code>:</p>
            <pre><code>// Server driver
'server' => env('OCTANE_SERVER', 'frankenphp'),

// Force HTTPS in production
'https' => env('OCTANE_HTTPS', false),

// Max execution time per request
'max_execution_time' => 30,

// Garbage collection threshold (MB)
'garbage' => 50,</code></pre>

            <h3>Horizon Configuration</h3>
            <p>Located at <code>config/horizon.php</code>:</p>
            <pre><code>'environments' => [
    'production' => [
        'supervisor-default' => [
            'connection' => 'redis',
            'queue' => ['high', 'default', 'low'],
            'balance' => 'auto',
            'maxProcesses' => 10,
            'minProcesses' => 2,
            'tries' => 3,
            'timeout' => 90,
        ],
    ],
    'staging' => [
        'supervisor-default' => [
            'maxProcesses' => 5,
            'minProcesses' => 1,
        ],
    ],
    'local' => [
        'supervisor-default' => [
            'maxProcesses' => 3,
            'balance' => 'simple',
        ],
    ],
],</code></pre>

            <h3>Cloudflare R2 Storage</h3>
            <p>Located at <code>config/filesystems.php</code>:</p>
            <pre><code>'r2' => [
    'driver' => 's3',
    'key' => env('CLOUDFLARE_R2_ACCESS_KEY_ID'),
    'secret' => env('CLOUDFLARE_R2_SECRET_ACCESS_KEY'),
    'region' => 'auto',
    'bucket' => env('CLOUDFLARE_R2_BUCKET'),
    'url' => env('CLOUDFLARE_R2_URL'),
    'endpoint' => env('CLOUDFLARE_R2_ENDPOINT'),
    'use_path_style_endpoint' => false,
    'visibility' => 'public',
],</code></pre>

            <h3>Key Environment Variables</h3>
            <table>
                <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Description</th>
                        <th>Example</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>OCTANE_SERVER</code></td>
                        <td>Octane server driver</td>
                        <td>frankenphp</td>
                    </tr>
                    <tr>
                        <td><code>DB_CONNECTION</code></td>
                        <td>Database driver</td>
                        <td>mysql</td>
                    </tr>
                    <tr>
                        <td><code>REDIS_HOST</code></td>
                        <td>Redis server hostname</td>
                        <td>redis-service</td>
                    </tr>
                    <tr>
                        <td><code>CACHE_STORE</code></td>
                        <td>Cache driver</td>
                        <td>redis</td>
                    </tr>
                    <tr>
                        <td><code>QUEUE_CONNECTION</code></td>
                        <td>Queue driver</td>
                        <td>redis</td>
                    </tr>
                    <tr>
                        <td><code>SESSION_DRIVER</code></td>
                        <td>Session storage</td>
                        <td>redis</td>
                    </tr>
                    <tr>
                        <td><code>FILESYSTEM_DISK</code></td>
                        <td>Default storage disk</td>
                        <td>r2</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="docker">
            <h2>Docker Configuration</h2>

            <h3>Production Dockerfile</h3>
            <p>Located at <code>infrastructure/docker/backend/Dockerfile</code></p>
            <pre><code># Multi-stage build
# Stage 1: Composer dependencies
# Stage 2: Frontend assets (if any)
# Stage 3: FrankenPHP production image

Base image: dunglas/frankenphp:1-php8.4-alpine

PHP Extensions:
- pdo_mysql (MySQL database)
- redis (Cache/Sessions/Queue)
- pcntl (Process control for Horizon)
- zip, gd, intl, opcache, bcmath, exif

Features:
- Non-root user (alsabiqoon)
- Optimized OPcache settings
- Health check endpoint (/up)
- Graceful shutdown support</code></pre>

            <h3>Development Dockerfile</h3>
            <p>Located at <code>infrastructure/docker/backend/Dockerfile.dev</code></p>
            <pre><code>Base image: php:8.4-fpm-alpine

Additional tools:
- Xdebug (debugging)
- Composer
- Higher memory limits
- Error display enabled</code></pre>

            <h3>Supervisor Configuration</h3>
            <p>Located at <code>infrastructure/docker/backend/supervisord.conf</code></p>
            <pre><code>[program:horizon]
command=php /app/artisan horizon
autostart=true
autorestart=true
stopwaitsecs=3600

[program:scheduler]
command=/bin/sh -c "while [ true ]; do php /app/artisan schedule:run; sleep 60; done"
autostart=true
autorestart=true</code></pre>

            <h3>PHP Production Settings</h3>
            <p>Located at <code>infrastructure/docker/backend/php.ini</code></p>
            <pre><code>memory_limit = 256M
max_execution_time = 30
opcache.enable = 1
opcache.validate_timestamps = 0
opcache.jit = 1255
opcache.jit_buffer_size = 128M</code></pre>
        </section>

        <section id="kubernetes">
            <h2>Kubernetes Deployment</h2>

            <h3>Architecture</h3>
            <div class="grid">
                <div class="card">
                    <h4>Backend Pods</h4>
                    <p>2-10 replicas with HPA based on CPU/memory. Serves API requests via Octane.</p>
                </div>
                <div class="card">
                    <h4>Horizon Workers</h4>
                    <p>1 replica running Horizon supervisor. Manages queue workers with auto-balancing.</p>
                </div>
                <div class="card">
                    <h4>Redis</h4>
                    <p>1 replica with persistent storage for cache, sessions, and queues.</p>
                </div>
            </div>

            <h3>Manifests Location</h3>
            <pre><code>infrastructure/kubernetes/
├── base/                    # Shared resources
│   ├── kustomization.yaml
│   ├── namespace.yaml
│   ├── backend/
│   │   ├── deployment.yaml
│   │   ├── service.yaml
│   │   └── hpa.yaml
│   ├── workers/
│   │   └── deployment.yaml
│   └── redis/
│       ├── deployment.yaml
│       ├── service.yaml
│       └── pvc.yaml
└── overlays/
    ├── staging/
    │   ├── kustomization.yaml
    │   ├── ingress.yaml
    │   └── configmap.yaml
    └── production/
        ├── kustomization.yaml
        ├── ingress.yaml
        └── configmap.yaml</code></pre>

            <h3>Deployment Commands</h3>
            <pre><code># Deploy to staging
kubectl apply -k infrastructure/kubernetes/overlays/staging

# Deploy to production
kubectl apply -k infrastructure/kubernetes/overlays/production

# Check status
kubectl get all -n alsabiqoon</code></pre>

            <h3>Resource Limits</h3>
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>CPU Request</th>
                        <th>CPU Limit</th>
                        <th>Memory Request</th>
                        <th>Memory Limit</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Backend</td>
                        <td>250m</td>
                        <td>500m</td>
                        <td>256Mi</td>
                        <td>512Mi</td>
                    </tr>
                    <tr>
                        <td>Horizon</td>
                        <td>100m</td>
                        <td>500m</td>
                        <td>256Mi</td>
                        <td>512Mi</td>
                    </tr>
                    <tr>
                        <td>Redis</td>
                        <td>100m</td>
                        <td>200m</td>
                        <td>128Mi</td>
                        <td>256Mi</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="testing">
            <h2>Testing (TDD)</h2>

            <h3>Test Suites</h3>
            <table>
                <thead>
                    <tr>
                        <th>Suite</th>
                        <th>Location</th>
                        <th>Purpose</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Unit</td>
                        <td><code>tests/Unit/</code></td>
                        <td>Isolated unit tests for classes/methods</td>
                    </tr>
                    <tr>
                        <td>Feature</td>
                        <td><code>tests/Feature/</code></td>
                        <td>HTTP tests for API endpoints</td>
                    </tr>
                    <tr>
                        <td>Integration</td>
                        <td><code>tests/Integration/</code></td>
                        <td>Database and service integration tests</td>
                    </tr>
                </tbody>
            </table>

            <h3>Base TestCase Helpers</h3>
            <pre><code>// Create authenticated user
$user = $this->createAuthenticatedUser();

// Assert successful response
$this->assertSuccessResponse($response, ['id', 'name']);

// Assert paginated response
$this->assertPaginatedResponse($response, ['id', 'name']);

// Assert validation error
$this->assertValidationError($response, ['email', 'password']);

// Assert HTTP status codes
$this->assertUnauthorized($response);
$this->assertForbidden($response);
$this->assertNotFound($response);
$this->assertCreated($response);
$this->assertNoContent($response);</code></pre>

            <h3>Running Tests</h3>
            <pre><code># Run all tests
php artisan test

# Run specific suite
php artisan test --testsuite=Unit
php artisan test --testsuite=Feature

# Run with coverage
php artisan test --coverage

# Run specific test
php artisan test --filter=UserTest

# Via Makefile
make test
make test-coverage</code></pre>

            <h3>Coverage Reports</h3>
            <p>Generated in <code>storage/coverage/</code>:</p>
            <ul>
                <li><code>html/</code> - Interactive HTML report</li>
                <li><code>clover.xml</code> - CI/CD integration</li>
                <li><code>coverage.txt</code> - Text summary</li>
            </ul>
        </section>

        <section id="commands">
            <h2>Common Commands</h2>

            <h3>Artisan Commands</h3>
            <pre><code># Development
php artisan serve                    # Start dev server
php artisan octane:start             # Start with Octane
php artisan horizon                  # Start queue workers

# Database
php artisan migrate                  # Run migrations
php artisan migrate:fresh --seed     # Reset and seed
php artisan db:seed                  # Run seeders

# Code Quality
./vendor/bin/pint                    # Format code (Laravel Pint)
php artisan test                     # Run tests

# Cache
php artisan config:cache             # Cache config
php artisan route:cache              # Cache routes
php artisan view:cache               # Cache views
php artisan optimize                 # Run all caches

# Passport
php artisan passport:keys            # Generate OAuth keys
php artisan passport:client          # Create OAuth client</code></pre>

            <h3>Makefile Commands</h3>
            <pre><code># Docker
make up                   # Start services
make down                 # Stop services
make logs                 # View logs
make shell-backend        # Backend shell

# Development
make migrate              # Run migrations
make fresh                # Fresh migrate with seeds
make test                 # Run tests
make test-coverage        # Tests with coverage
make lint                 # Run Laravel Pint

# Kubernetes
make k8s-staging          # Deploy to staging
make k8s-production       # Deploy to production</code></pre>
        </section>

        <section>
            <h2>API Endpoints</h2>
            <p>Define your API routes in <code>routes/api.php</code>. Common patterns:</p>

            <pre><code>// routes/api.php

use Illuminate\Support\Facades\Route;

// Public routes
Route::post('/login', [AuthController::class, 'login']);
Route::post('/register', [AuthController::class, 'register']);

// Protected routes (Passport auth)
Route::middleware('auth:api')->group(function () {
    Route::get('/user', [UserController::class, 'show']);
    Route::put('/user', [UserController::class, 'update']);

    // Resource routes
    Route::apiResource('projects', ProjectController::class);
});

// Admin routes (Filament handles these automatically at /admin)</code></pre>
        </section>
    </div>

    <footer>
        <p>Al-Sabiqoon Backend Documentation v1.0 | Generated December 2025</p>
        <p>Part of the Al-Sabiqoon Empire Blueprint</p>
    </footer>
</body>
</html>
